(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{1439:function(e,t,n){"use strict";n.r(t),n.d(t,"sendMessage",(function(){return R})),n.d(t,"editMessage",(function(){return F}));var a=n(24),r=n.n(a),o=n(30),i=n(107),c=n(5),s=n(354),l=n(220),d=n(415),m=n(636),u=n(9),b=n(349),p=n(1323),g=n(1),f=n.n(g),y=n(1346),v=n(4),O=n(45),j=n(141),h=n(273);function C(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?C(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const k="/me ";const w=e=>e instanceof v.MatrixEvent;async function _(e,t,{relation:n,replyToEvent:a,permalinkCreator:r,includeReplyLegacyFallback:o=!0,editedEvent:i}){const s=w(i),l=s?Boolean(i.replyEventId):w(a),d=s&&l,m=e.startsWith(k);m&&(e=e.slice(k.length)),e.startsWith("//")&&(e=e.slice(1));const u=t?await Object(y.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const n=Object(O.h)(t);Object(h.a)(n)&&Object(h.a)(n.roomIdOrAlias)&&e.replaceWith(n.roomIdOrAlias);break}}})),t.body.innerHTML}(e),b=d&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const n=t.split("\n").map((e=>e.trim()));return n.length>2&&n[0].startsWith("> ")&&0===n[1].length?`${n[0]}\n\n`:""}(i)||"",p=d&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(i)||"",g={msgtype:m?v.MsgType.Emote:v.MsgType.Text,body:s?`${b} * ${u}`:u},f=c.b.getValue("MessageComposerInput.useMarkdown"),C=t?e:f?await Object(y.plainToRich)(e,!0):null;C&&(g.format="org.matrix.custom.html",g.formatted_body=s?`${p} * ${C}`:C),s&&(g["m.new_content"]={msgtype:g.msgtype,body:u},C&&(g["m.new_content"].format="org.matrix.custom.html",g["m.new_content"].formatted_body=C));return function(e,t){t&&(e["m.relates_to"]=E(E({},e["m.relates_to"]||{}),t))}(g,s?E(E({},n),{},{rel_type:"m.replace",event_id:i.getId()}):n),!s&&a&&r&&Object(j.a)(g,a,{permalinkCreator:r,includeLegacyFallback:o}),g}var T=n(127),x=n(250),S=n(14),M=n(345);const P=["roomContext","mxClient"];async function R(e,t,n){var a;let{roomContext:b,mxClient:p}=n,g=r()(n,P);const{relation:f,replyToEvent:y,permalinkCreator:v}=g,{room:O}=b,h=null==O?void 0:O.roomId;if(!h)return;const C={eventName:"Composer",isEditing:!1,isLocation:!1,isReply:Boolean(y),inThread:(null==f?void 0:f.rel_type)===o.d.name};i.a.instance.trackEvent(C);let E=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(k)){const{cmd:t,args:n}=Object(T.d)(e);if(t){const e=(null==f?void 0:f.rel_type)===o.d.name?null==f?void 0:f.event_id:null;let a;if([E,a]=await Object(x.c)(p,t,n,h,null!=e?e:null),!a)return;if(!E||t.category!==T.a.messages&&t.category!==T.a.effects)return;var w,R;Object(M.b)(E,f),y&&Object(j.a)(E,y,{permalinkCreator:v,includeLegacyFallback:null===(w=null===(R=E.msgtype)||void 0===R?void 0:R.startsWith("m."))||void 0===w||w})}else{const t=await Object(x.d)(e);if(u.a.dispatch({action:S.a.FocusAComposer,context:b.timelineRenderingType}),!t)return}}if(null!==(a=E)&&void 0!==a||(E=await _(e,t,g)),!E.body.trim())return;c.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(s.a)(E);const F=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===o.d.name?f.event_id:null,W=Object(l.a)(h,(e=>p.sendMessage(e,F,E)),p);return y&&u.a.dispatch({action:"reply_to_event",event:null,context:b.timelineRenderingType}),u.a.dispatch({action:"message_sent"}),d.CHAT_EFFECTS.forEach((e=>{if(E&&Object(m.containsEmoji)(E,e.emojis)){(null==f?void 0:f.rel_type)!==o.d.name&&u.a.dispatch({action:`effects.${e.command}`})}})),c.b.getValue("Performance.addSendMessageTimingMetadata")&&W.then((e=>{Object(s.b)(p,h,e.event_id)})),c.b.getValue("scrollToBottomOnMessageSent")&&u.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:b.timelineRenderingType}),W}async function F(e,{roomContext:t,mxClient:n,editorStateTransfer:a}){const r=a.getEvent();i.a.instance.trackEvent({eventName:"Composer",isEditing:!0,isLocation:!1,inThread:Boolean(null==r?void 0:r.getThread()),isReply:Boolean(r.replyEventId)});const o=await _(e,!0,{editedEvent:r}),c=o["m.new_content"];if(""===(null==c?void 0:c.body))return Object(p.a)(n,a),void Object(b.a)({mxEvent:r,onCloseDialog:()=>{Object(p.b)(t)}});let s;const l=r.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(c,a)&&l){Object(p.a)(n,a);const e=a.getEvent().threadRootId||null;s=n.sendMessage(l,e,o),u.a.dispatch({action:"message_sent"})}return Object(p.b)(t),s}},1605:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return R}));var a=n(17),r=n.n(a),o=n(24),i=n.n(o),c=n(0),s=n.n(c),l=n(13),d=n.n(l),m=n(1436),u=n(2),b=n(10);function p({onCancelClick:e,onSaveClick:t,isSaveDisabled:n=!1}){return s.a.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},s.a.createElement(b.a,{kind:"secondary",onClick:e},Object(u.b)("Cancel")),s.a.createElement(b.a,{kind:"primary",onClick:t,disabled:n},Object(u.b)("Save")))}var g=n(9),f=n(14),y=n(28),v=n(632),O=n(1321),j=n(424),h=n(1322),C=n(1312);var E=n(21),k=n(1323),w=n(1439);var _=n(321),T=n(48),x=n(5);function S(e){const t=Object(y.c)(),n=Object(E.b)();return Object(c.useMemo)((()=>{if(e&&t.room&&n)return function(e,t,n){const a=new T.a(t,n);let r=[];if(e.hasEditorState()){const t=e.getSerializedParts();null!==t&&(r=t.map((e=>a.deserializePart(e))))}else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);r=Object(_.b)(e.getEvent(),a,{shouldEscape:x.b.getValue("MessageComposerInput.useMarkdown")})}return r.reduce(((e,t)=>e+(null==t?void 0:t.text)),"")}(e,t.room,n)}),[e,t,n])}const M=["editorStateTransfer","className"],P=Object(c.forwardRef)((function({disabled:e=!1,composerFunctions:t},n){return function(e,t,n){const a=Object(y.c)(),r=Object(C.c)(),o=Object(c.useRef)(null),i=Object(c.useCallback)((i=>{var c;if(e||!t.current)return;const s=null!==(c=i.context)&&void 0!==c?c:y.a.Room;switch(i.action){case f.a.FocusEditMessageComposer:Object(O.a)(t,s,a,o);break;case f.a.ComposerInsert:if(i.timelineRenderingType!==a.timelineRenderingType)break;if(i.composerType!==j.a.Edit)break;i.text&&Object(h.d)(r.selection).then((()=>n.insertText(i.text)))}}),[e,t,n,o,a,r]);Object(v.a)(g.a,i)}(e,n,t),null}));function R(e){let{editorStateTransfer:t,className:n}=e,a=i()(e,M);const o=Object(c.useRef)(Object(C.b)({editorStateTransfer:t})),l=S(t),u=!t||void 0!==l,{editMessage:b,endEditing:g,onChange:f,isSaveDisabled:v}=function(e,t){const n=Object(y.c)(),a=Object(E.b)(),[r,o]=Object(c.useState)(!0),[i,s]=Object(c.useState)(t);return{onChange:Object(c.useCallback)((e=>{s(e),o((n=>n&&e===t))}),[t]),editMessage:Object(c.useCallback)((async()=>{if(void 0!==a&&void 0!==i)return Object(w.editMessage)(i,{roomContext:n,mxClient:a,editorStateTransfer:e})}),[i,n,a,e]),endEditing:Object(c.useCallback)((()=>Object(k.b)(n)),[n]),isSaveDisabled:r}}(t,l);return u?s.a.createElement(C.a.Provider,{value:o.current},s.a.createElement(m.a,r()({className:d()("mx_EditWysiwygComposer",n),initialContent:l,onChange:f,onSend:b},a),((e,t)=>s.a.createElement(s.a.Fragment,null,s.a.createElement(P,{disabled:a.disabled,ref:e,composerFunctions:t}),s.a.createElement(p,{onCancelClick:g,onSaveClick:b,isSaveDisabled:v}))))):s.a.createElement(s.a.Fragment,null)}}}]);
//# sourceMappingURL=37.js.map